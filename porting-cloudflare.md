# Cloudflare移植仕様書

## 概要

AI秘書アプリケーションをCloudflare環境（Workers + D1 + AI）に移植するための仕様書。
本仕様書では、UIの動作仕様と二段階バリデーションのロジックを中心にまとめる。

## アーキテクチャ概要

### 現行システム
- バックエンド: Flask (Python)
- データベース: SQLite
- LLM: Ollama (ローカルLLM)
- フロントエンド: HTML/CSS/JavaScript

### 移植先
- バックエンド: Cloudflare Workers
- データベース: Cloudflare D1
- LLM: Cloudflare AI (Workers AI)
- フロントエンド: 同様 (HTML/CSS/JavaScript)

---

## データ構造

### 4つのデータタイプ

1. **属性 (Attributes)**: ユーザーの固定情報（名前、年齢、職業など）
2. **記憶 (Memories)**: エピソード、好み、知識、一般情報
3. **目標 (Goals)**: ユーザーの目標とその進捗
4. **お願い (Requests)**: AIアシスタントへの振る舞いに関する要望

### データフィールド

**属性**
- 名前、値、タイムスタンプ

**記憶**
- 内容、カテゴリ (general/preference/event/knowledge)
- 圧縮レベル (0-3)、アクティブ状態（論理削除対応）
- アクセス回数、最終アクセス日時

**目標**
- 内容、優先度 (1-10)、ステータス (active/completed/cancelled)
- 作成日時、更新日時、完了日時

**お願い**
- 内容、カテゴリ (tone/behavior/format/general)
- アクティブ状態

---

## UI仕様

### 1. メインチャット画面 (`/`)

#### ヘッダーセクション
- アプリタイトル: "AI秘書"
- メモリ処理インジケータ: 💾（非同期メモリ抽出中に表示）
- テストモードトグル: デバッグ情報表示/非表示切り替え
- DB管理ボタン: 管理画面へ遷移

#### チャットコンテナ
- メッセージ表示エリア: スクロール可能な会話履歴
- テキストエリア: ユーザー入力（自動リサイズ、Enterキーで送信）
- 送信ボタン
- 補助ボタン:
  - 履歴クリア: 会話履歴をリセット
  - 情報を整理: バックグラウンドで情報整理プロセスを開始

#### テストモードパネル（条件付き表示）
- デバッグ情報表示エリア:
  - MCPコンテキスト（ユーザー情報）
  - LLMリクエスト/レスポンス
  - メモリ抽出ログ
  - JSONシンタックスハイライト

#### 情報整理モーダル
- リアルタイム進捗表示
- 4ステッププロセス: 属性 → 記憶 → 目標 → お願い
- ポーリングベースのステータス更新（500ms間隔）

### 2. DB管理画面 (`/admin`)

#### タブナビゲーション
- 4つのデータタイプを切り替え（属性、記憶、目標、お願い）

#### データテーブル
- 各タイプに応じた列を持つテーブル表示
- CRUD操作:
  - 追加: モーダルフォームで新規作成
  - 編集: モーダルフォームで既存レコード更新
  - 削除: 記憶は論理削除、その他は物理削除

#### データ操作後の動作
- テーブルをリアルタイム更新
- フォームバリデーション

### 3. セッション管理

- セッションタイムアウト: 5分（設定可能）
- リセットトリガー:
  - ユーザーが「ありがとう」「ありがとうございます」と発言
  - タイムアウト経過
- リセット時の動作: 会話履歴をクリア、新規セッション開始

---

## 二段階バリデーション仕様

### Stage 1: メモリ抽出とバリデーション

**トリガー**: ユーザーメッセージ送信後（非同期バックグラウンド処理）

**処理フロー**:
1. **抽出プロンプト**: ユーザー入力と直前のAI応答をLLMに送信
2. **LLMによる分類**: 情報を4つのカテゴリに分類
3. **JSON解析**: LLM応答から正規表現でJSON部分を抽出
4. **構造バリデーション**: 必須フィールドの存在確認

**期待されるJSON構造**:
```json
{
  "attributes": [
    {"name": "属性名", "value": "値"}
  ],
  "memories": [
    {"content": "記憶内容", "category": "general|preference|event|knowledge"}
  ],
  "goals": [
    {"content": "目標内容", "priority": 1-10}
  ],
  "requests": [
    {"content": "お願い内容", "category": "tone|behavior|format|general"}
  ]
}
```

**バリデーションルール**:
- 各フィールドの型チェック
- 必須キーの存在確認（例: `'name' in attr and 'value' in attr`）
- 空・欠損フィールドは正常に処理（エラーにしない）
- JSON解析エラー時は空の結果として処理
- **重要**: AI応答は処理対象外（ユーザー入力のみ）

**データベース保存**:
- 各カテゴリごとに対応するテーブルに保存
- タイムスタンプ自動付与
- 重複チェックなし（Stage 2で処理）

### Stage 2: 情報整理と競合解決

**トリガー**: ユーザーが「情報を整理」ボタンをクリック

**処理フロー**: 4ステップを順次実行

#### ステップ1: 属性の整理
- **競合検出**: 同じ属性名で異なる値が存在するか判定
- **競合解決**: LLMで判断し、最新情報を保持
- **フォーマット正規化**: LLMで表現を統一

#### ステップ2: 記憶（エピソード）の整理
- **重複検出**: 意味が同じで表現が異なる記憶を検出
- **マージ操作**: 複数レコードを統合
- **フォーマット標準化**: 表現を統一
- **圧縮処理**: 古い記憶を年齢に応じて圧縮
  - Recent (< 7日): 圧縮なし (level 0)
  - Medium (< 30日): 軽度圧縮 (level 1)
  - Old (< 90日): 中度圧縮 (level 2)
  - Ancient (> 365日): 重度圧縮 (level 3)

#### ステップ3: 目標の整理
- **競合解決**: 重複・矛盾する目標を統合
- **フォーマット改善**: 表現を改善
- **優先度・ステータス保持**: 既存の優先度とステータスを維持

#### ステップ4: お願いの整理
- **重複検出**: 同一のお願いを検出
- **マージと標準化**: 統合してフォーマット統一

**LLMプロンプトの種類**:
- `DUPLICATE_DETECTION_PROMPT`: 類似アイテムの識別
- `CONFLICT_DETECTION_PROMPT`: 矛盾情報の検出
- `MERGE_PROMPT`: インテリジェントな統合
- `FORMAT_PROMPT`: テキスト正規化
- `COMPRESS_PROMPT`: レベル指定による圧縮

**処理の特徴**:
- 逐次実行（並列処理なし）でLLM負荷管理
- 各ステップ最大20アイテムまで処理
- 進捗コールバックでUI更新
- 全操作をログ記録

---

## API エンドポイント仕様

### チャット関連

| エンドポイント | メソッド | 用途 | リクエスト | レスポンス |
|--------------|---------|------|-----------|-----------|
| `/chat` | POST | ユーザーメッセージ処理とAI応答生成 | `{"message": str}` | `{"response": str, "history_reset": bool, "test_logs": array}` |
| `/history` | GET | 現在の会話履歴取得 | - | `{"history": [{"role": str, "content": str}]}` |
| `/clear_history` | POST | 会話履歴クリアとセッションリセット | - | `{"success": bool}` |
| `/test_mode` | GET/POST | テストモード状態の取得/設定 | POST: `{"enabled": bool}` | `{"test_mode": bool}` |

### データ管理

| エンドポイント | メソッド | 用途 |
|--------------|---------|------|
| `/api/data/<table>` | GET | テーブルから全レコード取得 |
| `/api/data/<table>` | POST | 新規レコード追加 |
| `/api/data/<table>/<id>` | PUT | 既存レコード更新 |
| `/api/data/<table>/<id>` | DELETE | レコード削除（記憶は論理削除） |

**対応テーブル**: `attributes`, `memories`, `goals`, `requests`

### 情報整理

| エンドポイント | メソッド | 用途 | 備考 |
|--------------|---------|------|------|
| `/organize` | POST | バックグラウンド整理プロセス開始 | 非ブロッキング、即座に返却 |
| `/organize/status` | GET | 整理進捗のポーリング | `{"is_organizing": bool, "logs": array}` |

### システムステータス

| エンドポイント | メソッド | 用途 |
|--------------|---------|------|
| `/api/system/status` | GET | LLM接続と利用可能モデルの確認 |
| `/api/system/processing_status` | GET | メモリ抽出の実行状態確認 |

---

## 主要機能とデータフロー

### 1. パーソナライズされたリアルタイムチャット

**処理フロー**:
```
ユーザー入力
  ↓
MCPコンテキスト取得（ユーザー情報）
  ↓
LLM API呼び出し（コンテキスト + 履歴）
  ↓
AI応答表示
  ↓
バックグラウンドスレッド: メモリ抽出
  ├─ LLMで分類
  ├─ JSONパース
  └─ データベース保存
```

**特徴**:
- ストリーミング風メッセージ表示（ローディングアニメーション）
- 自動セッションタイムアウト
- MCPコンテキストをシステムプロンプトに注入
- セッション単位の会話履歴管理

### 2. 自動メモリ抽出

- ユーザーメッセージごとに非同期実行
- AI応答を除外（ユーザー発話のみ処理）
- 4カテゴリへの自動分類
- エラー時の安全な処理

### 3. コンテキスト認識AI応答

**利用可能なコンテキスト**:
- ユーザー属性
- 最近の記憶（フィルタリング・件数制限可能）
- アクティブな目標
- カスタム指示（お願い）

**コンテキストフォーマット**:
- カテゴリヘッダー付き構造化テキスト
- 優先度マーカー（★）
- システムメッセージとしてLLMに渡す

---

## 実装上の注意点

### 非同期処理
- メモリ抽出: バックグラウンドスレッド（Workers環境では代替手段検討）
- 情報整理: 長時間実行（Durable Objectsの検討）
- ポーリング: 500ms間隔のステータスチェック

### エラーハンドリング
- JSON解析失敗時は空結果として処理
- LLM接続失敗時のフォールバック
- データベース操作エラーのユーザーへの適切な通知

### セキュリティ
- 入力バリデーション
- SQLインジェクション対策（パラメータ化クエリ）
- XSS対策（フロントエンドでのエスケープ処理）

### パフォーマンス
- 情報整理は各ステップ最大20アイテム
- 逐次実行でLLM負荷管理
- データベースクエリの最適化

---

## Cloudflare移植時の考慮事項

### Workers環境
- スレッドベースの非同期処理は不可 → Durable Objects or Queue検討
- セッション管理: KVまたはDurable Objects利用
- タイムアウト制限: CPU時間制限に注意

### D1データベース
- SQLiteベースなのでスキーマ設計の互換性は高い
- トランザクション処理の実装
- 論理削除の適切な実装

### Workers AI
- モデル選択（llama3.1:8b相当）
- APIインターフェースの差異対応
- レート制限とコスト管理

### フロントエンド
- 基本的にそのまま利用可能
- APIエンドポイントのベースURL変更のみ
- Workersとの通信形式確認

---

## テストモード機能

### 表示内容
- MCPコンテキスト（JSON）
- LLMリクエスト/レスポンス
- メモリ抽出ログ
- 整理プロセスのLLM対話履歴

### 用途
- デバッグ
- 開発中の動作確認
- LLMプロンプトチューニング

---

## まとめ

本仕様書は、AI秘書アプリケーションのCloudflare移植に必要な以下の要素をまとめたものである:

1. **UIの動作仕様**: チャット画面、DB管理画面、テストモードの詳細
2. **二段階バリデーション**: メモリ抽出（Stage 1）と情報整理（Stage 2）のロジック
3. **API仕様**: 全エンドポイントの入出力定義
4. **データフロー**: 主要機能の処理フロー
5. **移植時の注意点**: Cloudflare環境特有の制約と対策

テーブルスキーマはCloudflare D1に合わせて再設計すること。
